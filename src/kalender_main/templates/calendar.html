<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ month_name }} {{ year }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container">
   
      <div id="clock" class="clock-box"></div>

      <header>
        <a href="/{{ prev_year }}/{{ prev_month }}">< Eelmine kuu</a>
        <h1>{{ month_name }} {{ year }}</h1>
        <a href="/{{ next_year }}/{{ next_month }}">J√§rgmine kuu > </a>
      </header>

      <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Otsi..." />
      
      
      <div id="searchBox" class="search-box">
        <p>Sisesta kuup√§ev:</p>
        <div class="date-input-container">
          <input type="text" id="day" maxlength="2" placeholder="pp" class="date-field" />
          <span>/</span>
          <input type="text" id="month" maxlength="2" placeholder="kk" class="date-field" />
          <span>/</span>
          <input type="text" id="year" maxlength="4" placeholder="aaaa" class="date-field" />
        </div>

        
        <div id="noteBox" class="note-box">
          <textarea id="noteInput" placeholder="Lisa m√§rkmeid..." class="note-input"></textarea>
          <button id="saveNoteBtn" style="width: 100%; margin-top: 10px; padding: 8px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
           Salvesta m√§rge
           </button>
          <button id="searchBtn" style="width: 100%; margin-top: 6px; padding: 8px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
           Ava kuup√§ev
           </button>
        </div>
      </div>
    </div>

      <table>
        <tr>
          {% for day in weekday_names %}
          <th>{{ day }}</th>
          {% endfor %}
        </tr>
        {% for week in month_matrix %}
        <tr>
          {% for day in week %}
          {% if day == 0 %}
          <td></td>
          {% else %}
          <td class="calendar-day {% if day == today_day and month == today_month and year == today_year %}today{% endif %}" 
              data-date="{{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}">
            <div class="day-number">{{ day }}</div>
            <div class="day-note"></div>
          </td>
          {% endif %}
          {% endfor %}
        </tr>
        {% endfor %}
      </table>
    </div>

    
    <div id="noteModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalDate"></h2>
        <textarea id="modalNoteInput" class="modal-note-input" placeholder="Lisa m√§rkmeid..."></textarea>
        <div style="margin-top: 10px;">
          <button id="saveModalNote" class="modal-btn save-btn">Salvesta</button>
          <button id="deleteModalNote" class="modal-btn delete-btn">Kustuta m√§rge</button>
        </div>
      </div>
    </div>

    <script>
      let notesData = {{ notes|safe }};

      function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('clock').textContent = hours + ':' + minutes + ':' + seconds;
      }
      setInterval(updateClock, 1000);
      updateClock();

      
      function displayNotes() {
        document.querySelectorAll('.calendar-day').forEach(cell => {
          const date = cell.dataset.date;
          const noteDiv = cell.querySelector('.day-note');
          if (notesData[date]) {
            noteDiv.textContent = 'üìù';
            noteDiv.title = notesData[date];
          } else {
            noteDiv.textContent = '';
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        displayNotes();

        
        const urlParams = new URLSearchParams(window.location.search);
        const highlightDay = urlParams.get('highlight');
        if (highlightDay) {
          document.querySelectorAll('.calendar-day').forEach(cell => {
            const dateStr = cell.dataset.date;
            const dayNum = dateStr.split('-')[2];
            if (parseInt(dayNum) === parseInt(highlightDay)) {
              cell.classList.add('highlighted');
              cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        }

        // SEARCH BAR JA KAST
        const searchInput = document.getElementById('searchInput');
        const searchBox = document.getElementById('searchBox');

        searchInput.addEventListener('focus', () => {
          searchBox.classList.add('open');
        });

        document.addEventListener('click', (e) => {
          if (!searchBox.contains(e.target) && e.target !== searchInput) {
            searchBox.classList.remove('open');
          }
        });

        // KUUP√ÑEVA INPUT
        const day = document.getElementById('day');
        const month = document.getElementById('month');
        const year = document.getElementById('year');

        function autoTab(current, next, maxLength) {
          current.addEventListener('input', () => {
            current.value = current.value.replace(/\D/g,'');
            if (current.value.length >= maxLength && next) {
              next.focus();
            }
          });
        }

        autoTab(day, month, 2);
        autoTab(month, year, 2);

        // TEINE KAST (m√§rkmed)
        const noteInput = document.getElementById('noteInput');
        const noteBox = document.getElementById('noteBox');

        [day, month, year].forEach(input => {
          input.addEventListener('input', () => {
            const dayVal = day.value.length === 2;
            const monthVal = month.value.length === 2;
            const yearVal = year.value.length >= 2;
            
            if (dayVal && monthVal && yearVal) {
              noteBox.style.display = 'block';
              
              // Load existing note for this date
              const fullYear = year.value.length === 2 ? '20' + year.value : year.value;
              const dateKey = `${fullYear}-${month.value.padStart(2, '0')}-${day.value.padStart(2, '0')}`;
              noteInput.value = notesData[dateKey] || '';
            } else {
              noteBox.style.display = 'none';
            }
          });
        });

        // AUTOMAATNE K√ïRGUSE MUUTUS textarea-s
        noteInput.addEventListener('input', () => {
          noteInput.style.height = 'auto';
          noteInput.style.height = noteInput.scrollHeight + 'px';
        });

        
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        saveNoteBtn.addEventListener('click', async () => {
          if (day.value && month.value && year.value) {
            const fullYear = year.value.length === 2 ? '20' + year.value : year.value;
            const dateKey = `${fullYear}-${month.value.padStart(2, '0')}-${day.value.padStart(2, '0')}`;
            
            const response = await fetch('/api/notes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ date: dateKey, note: noteInput.value })
            });
            
            const data = await response.json();
            notesData = data.notes;
            displayNotes();
            alert('M√§rge salvestatud!');
          }
        });

        
        const searchBtn = document.getElementById('searchBtn');
        searchBtn.addEventListener('click', () => {
          if (day.value && month.value && year.value) {
            const fullYear = year.value.length === 2 ? '20' + year.value : year.value;
            window.location.href = `/${fullYear}/${month.value}?highlight=${day.value}`;
          }
        });

        
        const modal = document.getElementById('noteModal');
        const modalDate = document.getElementById('modalDate');
        const modalNoteInput = document.getElementById('modalNoteInput');
        const closeModal = document.querySelector('.close');
        const saveModalNote = document.getElementById('saveModalNote');
        const deleteModalNote = document.getElementById('deleteModalNote');
        let currentModalDate = null;

        document.querySelectorAll('.calendar-day').forEach(cell => {
          cell.addEventListener('click', () => {
            currentModalDate = cell.dataset.date;
            const [y, m, d] = currentModalDate.split('-');
            modalDate.textContent = `${d}.${m}.${y}`;
            modalNoteInput.value = notesData[currentModalDate] || '';
            modal.style.display = 'block';
          });
        });

        closeModal.addEventListener('click', () => {
          modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });

        saveModalNote.addEventListener('click', async () => {
          const response = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: currentModalDate, note: modalNoteInput.value })
          });
          
          const data = await response.json();
          notesData = data.notes;
          displayNotes();
          modal.style.display = 'none';
        });

        deleteModalNote.addEventListener('click', async () => {
          const response = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: currentModalDate, note: '' })
          });
          
          const data = await response.json();
          notesData = data.notes;
          displayNotes();
          modal.style.display = 'none';
        });
      });
    </script>
  </body>
</html>