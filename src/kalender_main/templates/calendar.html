<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ month_name }} {{ year }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container">
   
      <div id="clock" class="clock-box"></div>

      <header>
        <a href="/{{ prev_year }}/{{ prev_month }}">< Eelmine kuu</a>
        <h1>{{ month_name }} {{ year }}</h1>
        <a href="/{{ next_year }}/{{ next_month }}">Järgmine kuu > </a>
      </header>

      <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Otsi..." />
      
      
      <div id="searchBox" class="search-box">
        <p>Sisesta kuupäev:</p>
        <div class="date-input-container">
          <input type="text" id="day" maxlength="2" placeholder="pp" class="date-field" />
          <span>/</span>
          <input type="text" id="month" maxlength="2" placeholder="kk" class="date-field" />
          <span>/</span>
          <input type="text" id="year" maxlength="4" placeholder="aaaa" class="date-field" />
        </div>

        
        <div id="noteBox" class="note-box">
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Aeg</label>
            <input type="time" id="searchBoxTime" class="time-input" style="width: 130px;">
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Tegevus</label>
            <div class="activity-selector-small">
              <div class="activity-item-small">
                <div class="activity-circle-small" style="background: #FF6B6B;" data-activity="töö"></div>
                <div class="activity-name-small">Töö</div>
              </div>
              <div class="activity-item-small">
                <div class="activity-circle-small" style="background: #4ECDC4;" data-activity="treening"></div>
                <div class="activity-name-small">Treening</div>
              </div>
              <div class="activity-item-small">
                <div class="activity-circle-small" style="background: #45B7D1;" data-activity="õppimine"></div>
                <div class="activity-name-small">Õppimine</div>
              </div>
              <div class="activity-item-small">
                <div class="activity-circle-small" style="background: #FFA07A;" data-activity="sõbrad"></div>
                <div class="activity-name-small">Sõbrad</div>
              </div>
              <div class="activity-item-small">
                <div class="activity-circle-small" style="background: #98D8C8;" data-activity="puhkus"></div>
                <div class="activity-name-small">Puhkus</div>
              </div>
              <div class="activity-item-small">
                <div class="activity-circle-small" style="background: #F7DC6F;" data-activity="hobi"></div>
                <div class="activity-name-small">Hobi</div>
              </div>
            </div>
          </div>
          
          <textarea id="noteInput" placeholder="Lisa märkmeid..." class="note-input"></textarea>
          <button id="saveNoteBtn" style="width: 100%; margin-top: 10px; padding: 8px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
           Salvesta märge
           </button>
          <button id="searchBtn" style="width: 100%; margin-top: 6px; padding: 8px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
           Ava kuupäev
           </button>
        </div>
      </div>
    </div>

      <table>
        <tr>
          {% for day in weekday_names %}
          <th>{{ day }}</th>
          {% endfor %}
        </tr>
        {% for week in month_matrix %}
        <tr>
          {% for day in week %}
          {% if day == 0 %}
          <td></td>
          {% else %}
          <td class="calendar-day {% if day == today_day and month == today_month and year == today_year %}today{% endif %}" 
              data-date="{{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}">
            <div class="day-number">{{ day }}</div>
            <div class="day-activity-dot"></div>
            <div class="day-note"></div>
          </td>
          {% endif %}
          {% endfor %}
        </tr>
        {% endfor %}
      </table>
    </div>

    
    <div id="noteModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalDate"></h2>
        
        <div class="form-group">
          <label>Aeg</label>
          <input type="time" id="modalTime" class="time-input">
        </div>

        <div class="form-group">
          <label>Tegevus</label>
          <div class="activity-selector">
            <div class="activity-item">
              <div class="activity-circle" style="background: #FF6B6B;" data-activity="töö"></div>
              <div class="activity-name">Töö</div>
            </div>
            <div class="activity-item">
              <div class="activity-circle" style="background: #4ECDC4;" data-activity="treening"></div>
              <div class="activity-name">Treening</div>
            </div>
            <div class="activity-item">
              <div class="activity-circle" style="background: #45B7D1;" data-activity="õppimine"></div>
              <div class="activity-name">Õppimine</div>
            </div>
            <div class="activity-item">
              <div class="activity-circle" style="background: #FFA07A;" data-activity="sõbrad"></div>
              <div class="activity-name">Sõbrad</div>
            </div>
            <div class="activity-item">
              <div class="activity-circle" style="background: #98D8C8;" data-activity="puhkus"></div>
              <div class="activity-name">Puhkus</div>
            </div>
            <div class="activity-item">
              <div class="activity-circle" style="background: #F7DC6F;" data-activity="hobi"></div>
              <div class="activity-name">Hobi</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Märkmed</label>
          <textarea id="modalNoteInput" class="modal-note-input" placeholder="Lisa märkmeid..."></textarea>
        </div>

        <div style="margin-top: 10px;">
          <button id="saveModalNote" class="modal-btn save-btn">Salvesta</button>
          <button id="deleteModalNote" class="modal-btn delete-btn">Kustuta märge</button>
        </div>
      </div>
    </div>

    <script>
      let notesData = {{ notes|safe }};
      let selectedActivity = null;
      let selectedSearchBoxActivity = null;

      function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('clock').textContent = hours + ':' + minutes + ':' + seconds;
      }
      setInterval(updateClock, 1000);
      updateClock();

      
      function displayNotes() {
        document.querySelectorAll('.calendar-day').forEach(cell => {
          const date = cell.dataset.date;
          const noteDiv = cell.querySelector('.day-note');
          const activityDot = cell.querySelector('.day-activity-dot');
          
          if (notesData[date]) {
            const noteText = notesData[date];
            noteDiv.textContent = '';
            noteDiv.title = noteText;
            
            // Extract activity color from note
            const colorMatch = noteText.match(/\[COLOR:(#[A-Fa-f0-9]{6}|rgb\([0-9, ]+\))\]/);
            if (colorMatch) {
              activityDot.style.background = colorMatch[1];
              activityDot.style.display = 'block';
            } else {
              activityDot.style.display = 'none';
            }
          } else {
            noteDiv.textContent = '';
            activityDot.style.display = 'none';
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        displayNotes();

        
        const urlParams = new URLSearchParams(window.location.search);
        const highlightDay = urlParams.get('highlight');
        if (highlightDay) {
          document.querySelectorAll('.calendar-day').forEach(cell => {
            const dateStr = cell.dataset.date;
            const dayNum = dateStr.split('-')[2];
            if (parseInt(dayNum) === parseInt(highlightDay)) {
              cell.classList.add('highlighted');
              cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        }

        // SEARCH BAR JA KAST
        const searchInput = document.getElementById('searchInput');
        const searchBox = document.getElementById('searchBox');

        searchInput.addEventListener('focus', () => {
          searchBox.classList.add('open');
        });

        document.addEventListener('click', (e) => {
          if (!searchBox.contains(e.target) && e.target !== searchInput) {
            searchBox.classList.remove('open');
          }
        });

        // KUUPÄEVA INPUT
        const day = document.getElementById('day');
        const month = document.getElementById('month');
        const year = document.getElementById('year');

        function autoTab(current, next, maxLength) {
          current.addEventListener('input', () => {
            current.value = current.value.replace(/\D/g,'');
            if (current.value.length >= maxLength && next) {
              next.focus();
            }
          });
        }

        autoTab(day, month, 2);
        autoTab(month, year, 2);

        // TEINE KAST (märkmed)
        const noteInput = document.getElementById('noteInput');
        const noteBox = document.getElementById('noteBox');

        [day, month, year].forEach(input => {
          input.addEventListener('input', () => {
            const dayVal = day.value.length === 2;
            const monthVal = month.value.length === 2;
            const yearVal = year.value.length >= 2;
            
            if (dayVal && monthVal && yearVal) {
              noteBox.style.display = 'block';
              
              // Load existing note for this date
              const fullYear = year.value.length === 2 ? '20' + year.value : year.value;
              const dateKey = `${fullYear}-${month.value.padStart(2, '0')}-${day.value.padStart(2, '0')}`;
              const existingNote = notesData[dateKey] || '';
              
              // Extract time
              const timeMatch = existingNote.match(/⏰ (\d{2}:\d{2})/);
              const searchBoxTime = document.getElementById('searchBoxTime');
              if (timeMatch) {
                searchBoxTime.value = timeMatch[1];
              } else {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                searchBoxTime.value = `${hours}:${minutes}`;
              }
              
              // Extract activity color and select it
              const colorMatch = existingNote.match(/\[COLOR:(#[A-Fa-f0-9]{6}|rgb\([0-9, ]+\))\]/);
              document.querySelectorAll('.activity-circle-small').forEach(c => {
                c.classList.remove('selected');
              });
              selectedSearchBoxActivity = null;
              
              if (colorMatch) {
                const color = colorMatch[1];
                document.querySelectorAll('.activity-circle-small').forEach(c => {
                  if (c.style.background === color || c.style.backgroundColor === color) {
                    c.classList.add('selected');
                    selectedSearchBoxActivity = {
                      type: c.dataset.activity,
                      color: color
                    };
                  }
                });
              }
              
              // Extract clean note text (remove time, activity, and color metadata)
              let cleanNote = existingNote.replace(/⏰ \d{2}:\d{2}/, '').trim();
              cleanNote = cleanNote.replace(/\| [^\n]+/, '').trim();
              cleanNote = cleanNote.replace(/\[COLOR:[^\]]+\]/, '').trim();
              noteInput.value = cleanNote;
            } else {
              noteBox.style.display = 'none';
            }
          });
        });

        // AUTOMAATNE KÕRGUSE MUUTUS textarea-s
        noteInput.addEventListener('input', () => {
          noteInput.style.height = 'auto';
          noteInput.style.height = noteInput.scrollHeight + 'px';
        });

        
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        saveNoteBtn.addEventListener('click', async () => {
          if (day.value && month.value && year.value) {
            const fullYear = year.value.length === 2 ? '20' + year.value : year.value;
            const dateKey = `${fullYear}-${month.value.padStart(2, '0')}-${day.value.padStart(2, '0')}`;
            
            let noteText = noteInput.value;
            const searchBoxTime = document.getElementById('searchBoxTime');
            
            // Add time and activity to note if they exist
            if (searchBoxTime.value || selectedSearchBoxActivity) {
              let prefix = '';
              if (searchBoxTime.value) {
                prefix += `⏰ ${searchBoxTime.value}`;
              }
              if (selectedSearchBoxActivity) {
                prefix += ` | ${selectedSearchBoxActivity.type}`;
                prefix += ` [COLOR:${selectedSearchBoxActivity.color}]`;
              }
              noteText = prefix + (noteText ? '\n' + noteText : '');
            }
            
            const response = await fetch('/api/notes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ date: dateKey, note: noteText })
            });
            
            const data = await response.json();
            notesData = data.notes;
            displayNotes();
            alert('Märge salvestatud!');
          }
        });

        
        const searchBtn = document.getElementById('searchBtn');
        searchBtn.addEventListener('click', () => {
          if (day.value && month.value && year.value) {
            const fullYear = year.value.length === 2 ? '20' + year.value : year.value;
            window.location.href = `/${fullYear}/${month.value}?highlight=${day.value}`;
          }
        });

        
        const modal = document.getElementById('noteModal');
        const modalDate = document.getElementById('modalDate');
        const modalNoteInput = document.getElementById('modalNoteInput');
        const modalTime = document.getElementById('modalTime');
        const closeModal = document.querySelector('.close');
        const saveModalNote = document.getElementById('saveModalNote');
        const deleteModalNote = document.getElementById('deleteModalNote');
        let currentModalDate = null;

        // Activity circle selection
        document.querySelectorAll('.activity-circle').forEach(circle => {
          circle.addEventListener('click', function() {
            document.querySelectorAll('.activity-circle').forEach(c => {
              c.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedActivity = {
              type: this.dataset.activity,
              color: this.style.background
            };
          });
        });

        // Activity circle selection for search box
        document.querySelectorAll('.activity-circle-small').forEach(circle => {
          circle.addEventListener('click', function() {
            document.querySelectorAll('.activity-circle-small').forEach(c => {
              c.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedSearchBoxActivity = {
              type: this.dataset.activity,
              color: this.style.background
            };
          });
        });

        document.querySelectorAll('.calendar-day').forEach(cell => {
          cell.addEventListener('click', () => {
            currentModalDate = cell.dataset.date;
            const [y, m, d] = currentModalDate.split('-');
            modalDate.textContent = `${d}.${m}.${y}`;
            
            // Load existing note and parse it
            const existingNote = notesData[currentModalDate] || '';
            
            // Extract time
            const timeMatch = existingNote.match(/⏰ (\d{2}:\d{2})/);
            if (timeMatch) {
              modalTime.value = timeMatch[1];
            } else {
              const now = new Date();
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              modalTime.value = `${hours}:${minutes}`;
            }
            
            // Extract activity color and select it
            const colorMatch = existingNote.match(/\[COLOR:(#[A-Fa-f0-9]{6}|rgb\([0-9, ]+\))\]/);
            document.querySelectorAll('.activity-circle').forEach(c => {
              c.classList.remove('selected');
            });
            selectedActivity = null;
            
            if (colorMatch) {
              const color = colorMatch[1];
              document.querySelectorAll('.activity-circle').forEach(c => {
                if (c.style.background === color || c.style.backgroundColor === color) {
                  c.classList.add('selected');
                  selectedActivity = {
                    type: c.dataset.activity,
                    color: color
                  };
                }
              });
            }
            
            // Extract clean note text (remove time, activity, and color metadata)
            let cleanNote = existingNote.replace(/⏰ \d{2}:\d{2}/, '').trim();
            cleanNote = cleanNote.replace(/\| [^\n]+/, '').trim();
            cleanNote = cleanNote.replace(/\[COLOR:[^\]]+\]/, '').trim();
            modalNoteInput.value = cleanNote;
            
            modal.style.display = 'block';
          });
        });

        closeModal.addEventListener('click', () => {
          modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });

        saveModalNote.addEventListener('click', async () => {
          let noteText = modalNoteInput.value;
          
          // Add time and activity to note if they exist
          if (modalTime.value || selectedActivity) {
            let prefix = '';
            if (modalTime.value) {
              prefix += `⏰ ${modalTime.value}`;
            }
            if (selectedActivity) {
              prefix += ` | ${selectedActivity.type}`;
              // Add hidden color marker for calendar display
              prefix += ` [COLOR:${selectedActivity.color}]`;
            }
            noteText = prefix + (noteText ? '\n' + noteText : '');
          }
          
          const response = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: currentModalDate, note: noteText })
          });
          
          const data = await response.json();
          notesData = data.notes;
          displayNotes();
          modal.style.display = 'none';
        });

        deleteModalNote.addEventListener('click', async () => {
          const response = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: currentModalDate, note: '' })
          });
          
          const data = await response.json();
          notesData = data.notes;
          displayNotes();
          modal.style.display = 'none';
        });
      });
    </script>
  </body>
</html>